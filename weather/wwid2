Option Explicit

Public Sub ExportTableCaptionsToCSV_2()

    Dim doc As Document
    Set doc = ActiveDocument
    
    If doc.Path = "" Then
        MsgBox "Please save the document first.", vbExclamation
        Exit Sub
    End If
    
    Dim outPath As String
    outPath = doc.Path & Application.PathSeparator & "table_captions_2.csv"
    
    ' Regex pattern
    Dim re As Object
    Set re = CreateObject("VBScript.RegExp")
    With re
        .Global = False
        .IgnoreCase = True
        .MultiLine = False
        .Pattern = "^\s*(Table\s+\d+(?:-\d+)*)\s*:\s*(\S.*)\s*$"
    End With
    
    ' UTF-8 output
    Dim stm As Object
    Set stm = CreateObject("ADODB.Stream")
    stm.Type = 2
    stm.Charset = "utf-8"
    stm.Open
    
    stm.WriteText "table_number,caption_text" & vbCrLf
    
    Dim storyRange As Range
    Dim p As Paragraph
    Dim txt As String
    Dim m As Object
    Dim tableNum As String
    Dim captionText As String
    Dim count As Long
    count = 0
    
    ' Loop through ALL story ranges (main body, headers, footers, shapes, etc.)
    For Each storyRange In doc.StoryRanges
        Do
            For Each p In storyRange.Paragraphs
                txt = CleanParaText(p.Range.Text)
                
                If Len(txt) > 0 Then
                    If re.Test(txt) Then
                        Set m = re.Execute(txt)(0)
                        
                        tableNum = Trim$(m.SubMatches(0))
                        captionText = Trim$(m.SubMatches(1))
                        
                        stm.WriteText CsvEscape(tableNum) & "," & _
                                      CsvEscape(captionText) & vbCrLf
                        
                        count = count + 1
                    End If
                End If
            Next p
            
            Set storyRange = storyRange.NextStoryRange
        Loop Until storyRange Is Nothing
    Next storyRange
    
    stm.SaveToFile outPath, 2
    stm.Close
    
    MsgBox "Exported " & count & " captions to:" & vbCrLf & outPath, vbInformation
    
End Sub

Private Function CleanParaText(ByVal s As String) As String
    s = Replace(s, vbCr, "")
    s = Replace(s, Chr$(7), "")
    CleanParaText = Trim$(s)
End Function

Private Function CsvEscape(ByVal s As String) As String
    Dim needsQuotes As Boolean
    needsQuotes = (InStr(s, ",") > 0) Or _
                  (InStr(s, """") > 0) Or _
                  (InStr(s, vbLf) > 0) Or _
                  (InStr(s, vbCr) > 0)
    
    s = Replace(s, """", """""")
    
    If needsQuotes Then
        CsvEscape = """" & s & """"
    Else
        CsvEscape = s
    End If
End Function
