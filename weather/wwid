import pandas as pd
import numpy as np

def calculate_migration_matrix(df, period_months=12):
    # Sort by gcdu_id and cohort_date to ensure proper order for tracking rating changes
    df = df.sort_values(by=['gcdu_id', 'cohort_date'])

    # Create a new column 'end_date' that shifts 'cohort_date' by 'period_months'
    df['end_date'] = df['cohort_date'] + pd.DateOffset(months=period_months)
    
    # Merge to get ratings at the 'end_date' for each obligor
    migration_df = pd.merge(
        df, df[['gcdu_id', 'proposed_final_crr', 'cohort_date']], 
        left_on=['gcdu_id', 'end_date'], 
        right_on=['gcdu_id', 'cohort_date'], 
        suffixes=('_start', '_end'), 
        how='inner'
    )

    # Create a cross-tabulation (pivot table) for rating migrations
    migration_matrix = pd.crosstab(migration_df['proposed_final_crr_start'], migration_df['proposed_final_crr_end'], 
                                   normalize='index')

    # Return the migration matrix
    return migration_matrix

# Example usage:
migration_matrix_12months = calculate_migration_matrix(cohort_data, period_months=12)
migration_matrix_24months = calculate_migration_matrix(cohort_data, period_months=24)

# Display migration matrix for 12 months
print("Migration Matrix for 12 months:")
print(migration_matrix_12months)

# Display migration matrix for 24 months
print("Migration Matrix for 24 months:")
print(migration_matrix_24months)
